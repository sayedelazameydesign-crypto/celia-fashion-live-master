{% extends 'layout.html' %}

{% block title %}{{ product.name }} | Celia Fashion Live{% endblock %}

{% block extra_head %}
    <meta name="description" content="{{ product.meta_description or (product.description[:160] if product.description else '') }}">
    <meta name="keywords" content="ملابس, {{ product.name }}, {{ product.category }}, سيليا فاشون">
{% endblock %}

{% block content %}
<div class="bg-white">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
        
        <nav class="text-sm text-gray-500 mb-6">
            <a href="{{ url_for('main.index') }}" class="hover:text-purple-600">الرئيسية</a>
            <span class="mx-2">/</span>
            <a href="#" class="hover:text-purple-600">{{ product.category }}</a>
            <span class="mx-2">/</span>
            <span class="text-gray-800 font-medium">{{ product.name }}</span>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12" x-data="productPage()">

            <div class="space-y-4">
                <div class="aspect-w-1 aspect-h-1 w-full bg-gray-100 rounded-lg overflow-hidden shadow-lg relative">
                    <div x-show="!show3D" class="transition-opacity duration-300">
                        <img :src="activeImage" alt="{{ product.name }}" class="w-full h-full object-cover">
                    </div>
                    <div x-show="show3D" id="viewer-3d-container" class="viewer-3d w-full h-full absolute inset-0 transition-opacity duration-300">
                        <div id="loading-3d" class="absolute inset-0 flex items-center justify-center bg-gray-100">
                            <div class="text-center">
                                <div class="loader mx-auto mb-4"></div>
                                <p class="text-gray-600">جاري تحميل النموذج...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-center space-x-2 space-x-reverse">
                    <template x-for="image in productImages" :key="image">
                        <button @click="activeImage = image; show3D = false" class="w-16 h-16 rounded-md overflow-hidden border-2 transition" :class="activeImage === image && !show3D ? 'border-purple-500' : 'border-transparent'">
                            <img :src="image" alt="Thumbnail" class="w-full h-full object-cover">
                        </button>
                    </template>
                    {% if product.model_3d_url %}
                    <button @click="toggle3D()" class="w-16 h-16 rounded-md border-2 flex items-center justify-center bg-gray-100" :class="show3D ? 'border-purple-500' : 'border-transparent'">
                        <span class="text-2xl font-bold">3D</span>
                    </button>
                    {% endif %}
                </div>
            </div>

            <div class="flex flex-col justify-center">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">{{ product.name }}</h1>
                <p class="text-gray-600 text-lg mb-4">{{ product.category }} - {{ product.color }}</p>

                <div class="mb-6">
                    <span class="text-4xl font-bold text-purple-600">{{ product.price }} جنيه</span>
                </div>

                <div class="prose max-w-none text-gray-700 mb-6">
                    <p>{{ product.description or "وصف قصير وجذاب للمنتج يبرز أهم مميزاته." }}</p>
                </div>

                <div class="mb-6" x-data="{ selectedSize: null }">
                    <h3 class="text-md font-medium text-gray-800 mb-2">اختاري مقاسك:</h3>
                    <div class="flex flex-wrap gap-2">
                        {% for size in product.sizes or ['S', 'M', 'L', 'XL'] %}
                            <button @click="selectedSize = '{{ size }}'" class="px-4 py-2 border rounded-lg transition" :class="selectedSize === '{{ size }}' ? 'bg-purple-600 text-white border-purple-600' : 'bg-white text-gray-700 hover:bg-gray-50'">
                                {{ size }}
                            </button>
                        {% endfor %}
                    </div>
                </div>

                <button class="w-full gradient-bg text-white font-bold py-4 px-6 rounded-lg shadow-lg hover:opacity-90 transition transform hover:scale-105" {% if product.stock == 0 %}disabled{% endif %}>
                    {% if product.stock > 0 %} أضف إلى السلة {% else %} غير متوفر حالياً {% endif %}
                </button>
            </div>
        </div>

        <div class="mt-12 lg:mt-16">
             <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-4 space-x-reverse" x-data="{ activeTab: 'description' }">
                    <button @click="activeTab = 'description'" :class="activeTab === 'description' ? 'border-purple-500 text-purple-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">الوصف الكامل</button>
                    <button @click="activeTab = 'reviews'" :class="activeTab === 'reviews' ? 'border-purple-500 text-purple-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">التقييمات (5)</button>
                </nav>
            </div>
            <div x-data="{ activeTab: 'description' }" class="py-6">
                <div x-show="activeTab === 'description'" class="prose max-w-none text-gray-600">
                    <p>{{ product.description or "هنا يتم وضع وصف طويل ومفصل للمنتج." }}</p>
                    <ul>
                        <li>الخامة: {{ product.material or 'غير محدد' }}</li>
                        <li>اللون: {{ product.color or 'غير محدد' }}</li>
                    </ul>
                </div>
                <div x-show="activeTab === 'reviews'" class="space-y-6">
                    <div class="border-b pb-4"><p class="font-medium text-gray-800">علياء محمد</p><p class="text-sm text-gray-500">منتج رائع وخامة ممتازة. ⭐⭐⭐⭐⭐</p></div>
                    <div class="border-b pb-4"><p class="font-medium text-gray-800">سارة حسين</p><p class="text-sm text-gray-500">شيك جداً والمقاس مظبوط. ⭐⭐⭐⭐</p></div>
                </div>
            </div>
        </div>

        <section class="mt-12 lg:mt-16" id="recommendations-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">قد يعجبك أيضاً</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6" id="recommendations-grid"></div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let scene, camera, renderer, controls, model;
let autoRotate = false;

function init3DViewer() {
    const container = document.getElementById('viewer-3d-container');
    const loading = document.getElementById('loading-3d');
    if (!container || container.querySelector('canvas')) return; // Already initialized

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf5f5f5);
    camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(0, 1, 3);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.shadowMap.enabled = true;
    container.appendChild(renderer.domElement);
    
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(5, 10, 5);
    directionalLight.castShadow = true;
    scene.add(directionalLight);
    
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    
    {% if product.model_3d_url %}
    const loader = new THREE.GLTFLoader();
    loader.load('{{ product.model_3d_url }}', (gltf) => {
        model = gltf.scene;
        scene.add(model);
        loading.style.display = 'none';
        const box = new THREE.Box3().setFromObject(model);
        const center = box.getCenter(new THREE.Vector3());
        model.position.sub(center);
        animate();
    }, undefined, (error) => {
        console.error('Error loading model:', error);
        loading.innerHTML = '<p class="text-red-600">خطأ في تحميل النموذج</p>';
    });
    {% else %}
    loading.innerHTML = '<p class="text-gray-600">لا يوجد نموذج 3D</p>';
    {% endif %}
    
    window.addEventListener('resize', onWindowResize);
}

function animate() {
    requestAnimationFrame(animate);
    if (autoRotate && model) model.rotation.y += 0.005;
    controls.update();
    renderer.render(scene, camera);
}

function onWindowResize() {
    const container = document.getElementById('viewer-3d-container');
    if (camera && renderer && container) {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    }
}

function productPage() {
    return {
        show3D: false,
        activeImage: '{{ product.thumbnail_url or "https://via.placeholder.com/600" }}',
        productImages: ['{{ product.thumbnail_url or "https://via.placeholder.com/600" }}'],
        toggle3D() {
            this.show3D = !this.show3D;
            if (this.show3D) {
                this.$nextTick(() => init3DViewer());
            }
        }
    }
}

function loadRecommendations(productId) {
    const recommendationsGrid = document.getElementById('recommendations-grid');
    if (!recommendationsGrid) return;
    fetch(`/api/ai/recommend/${productId}?limit=4`)
        .then(response => response.json())
        .then(data => {
            if (data.recommendations && data.recommendations.length > 0) {
                recommendationsGrid.innerHTML = '';
                data.recommendations.forEach(rec => {
                    const productCard = `
                        <div class="card-hover bg-white rounded-lg shadow-md overflow-hidden">
                            <a href="/product/${rec.id}">
                                <img src="${rec.thumbnail_url || 'https://via.placeholder.com/300'}" alt="${rec.name}" class="w-full h-48 object-cover">
                                <div class="p-4">
                                    <h3 class="font-bold text-gray-800 text-sm mb-1 truncate">${rec.name}</h3>
                                    <span class="text-purple-600 font-bold">${rec.price} جنيه</span>
                                </div>
                            </a>
                        </div>`;
                    recommendationsGrid.innerHTML += productCard;
                });
            } else {
                document.getElementById('recommendations-section').style.display = 'none';
            }
        });
}

document.addEventListener('DOMContentLoaded', () => {
    loadRecommendations({{ product.id }});
});
</script>
{% endblock %}
